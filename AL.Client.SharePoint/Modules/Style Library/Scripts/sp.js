//! require("deferred.js", "deferred")
//! require("ajax.js", "ajax")
var sp=function(){function a(a,b){var d=new deferred;b=b||{WithPictureDetail:"1",PictureSize:"Size_36px"};var e=new ContextInfo;e.Templates={},e.Templates.Fields={};var f={EffectivePresenceEnabled:"1",PresenceAlt:"User Presence"},g={id:a.AccountName,department:a.Role,jobTitle:a.Title,title:a.PreferredName,email:a.WorkEmail,picture:a.PictureURL,sip:a.SipAddress};return c.loadScripts("clienttemplates.js").done(function(){var a=RenderUserFieldWorker(e,b,g,f);d.resolve(a)}),d.promise()}var b={},c={loadScripts:function(a){a=Array.isArray(a)?a:[a];var b=new deferred;return c.context.webServerRelativeUrl.done(function(c){for(var d=0;d<a.length;d++)_v_dictSod[a[d]]||SP.SOD.registerSod(a[d],c+"/_layouts/15/"+a[d]);var e=a.map(function(a){var b=new deferred;return SP.SOD.loadMultiple([a],function(){b.resolve()}),b.promise()});deferred.all(e).done(b.resolve.bind(b))}),b.promise()},getJSON:function(a){return ajax.getJSON(a,"application/json; odata=verbose")},postJSON:function(a,b,d){b=b||{};var e=new deferred;return d?ajax.postJSON(a,b,"application/json; odata=verbose",{"X-RequestDigest":d,"Content-Type":"application/json; odata=verbose"}).done(e.resolve.bind(e)).fail(e.reject.bind(e)):c.context.digest.done(function(d){c.postJSON(a,b,d).done(e.resolve.bind(e)).fail(e.reject.bind(e))}),e.promise()},context:{pageInfo:function(a){var b=new deferred;if(_spPageContextInfo){var d=a?_spPageContextInfo[a]:_spPageContextInfo;b.resolve(d)}else c.loadScripts("sp.js").done(function(){var c=a?_spPageContextInfo[a]:_spPageContextInfo;b.resolve(c)});return b.promise()},get webServerRelativeUrl(){var a=new deferred;return c.context.pageInfo("webServerRelativeUrl").done(function(b){b=b.replace(/\/$/,""),a.resolve(b)}),a.promise()},get digest(){var a=new deferred;return c.context.webServerRelativeUrl.done(function(b){c.postJSON(b+"/_api/contextinfo",{},"temp").done(function(b){a.resolve(b.d.GetContextWebInformation.FormDigestValue)})}),a.promise()}},user:{getById:function(a){var b=new deferred;return c.context.webServerRelativeUrl.done(function(d){c.getJSON(d+"/_api/web/GetUserById("+a+")").done(b.resolve.bind(b)).fail(b.resolve.bind(b))}),b.promise()}},csom:{webparts:{getProperties:function(a){var b=new deferred,c=SP.ClientContext.get_current(),d=c.get_web().getFileByServerRelativeUrl(_spPageContextInfo.serverRequestPath),e=d.getLimitedWebPartManager(SP.WebParts.PersonalizationScope.shared),f=e.get_webParts();return c.load(f),c.executeQueryAsync(function(){for(var d=null,e=0;e<f.get_count()&&!d;e++){var g=f.get_item(e);g.get_id().toString()===a&&(d=g)}if(!d)return void b.reject("Web Part: "+a+" not found on page: "+_spPageContextInfo.webServerRelativeUrl);var h=d.get_webPart().get_properties();c.load(h),c.executeQueryAsync(function(){b.resolve(h,d,c)},function(){b.reject("Failed to load web part properties")})},function(){b.reject("Failed to load web part collection")}),b.promise()},saveProperties:function(a,b){var d=new deferred;return c.csom.webparts.getProperties(a).done(function(a,c,e){for(var f in b)a.set_item(f,b[f]);c.saveWebPartChanges(),e.executeQueryAsync(function(){d.resolve()},function(){d.reject("Failed to save web part properties")})}).fail(d.reject.bind(d)),d.promise()},updateProperties:function(a,b){var d=new deferred;return c.csom.webparts.getProperties(a).done(function(e){var f=b(e.get_fieldValues());c.csom.webparts.saveProperties(a,f).done(d.resolve.bind(d)).fail(d.reject.bind(d))}).fail(d.reject.bind(d)),d.promise()}},user:{profileProperties:function(a,b){var d=new deferred;return a===parseInt(a)?c.user.getById(a).done(function(a){c.csom.user.profileProperties(a.d.LoginName,b).done(d.resolve.bind(d)).fail(d.reject.bind(d))}).fail(function(){d.reject("Error encountered resolving user with Id: "+a)}):c.loadScripts(["sp.js","SP.UserProfiles.js"]).done(function(){var c=SP.ClientContext.get_current(),e=new SP.UserProfiles.UserProfilePropertiesForUser(c,a,b),f=new SP.UserProfiles.PeopleManager(c),g=f.getUserProfilePropertiesFor(e);c.load(e),c.executeQueryAsync(function(){for(var a={},c=0;c<b.length;c++)a[b[c]]=g[c];d.resolve(a)},function(){d.reject("Unable to load profile for user: "+a+" -- Properties: "+b.join(", "))})}),d.promise()},renderUserPresence:function(d,e){var f=new deferred;if(b[d])b[d].html?f.resolve(b[d].html):b[d].deferreds.push(f);else{b[d]={deferreds:[],html:null};var g=["PreferredName","PictureURL","AccountName","Title","WorkEmail","SipAddress"];c.csom.user.profileProperties(d,g).done(function(c){a(c,e).done(function(a){b[d].html=a;for(var c=0;c<b[d].deferreds.length;c++)b[d].deferreds[c].resolve(a);f.resolve(a)})})}return f.promise()}}},page:{get inEditMode(){var a=null;document.forms[MSOWebPartPageFormName].MSOLayout_InDesignMode&&(a="1"==document.forms[MSOWebPartPageFormName].MSOLayout_InDesignMode.value);var b=null;return document.forms[MSOWebPartPageFormName]._wikiPageMode&&(b="Edit"==document.forms[MSOWebPartPageFormName]._wikiPageMode.value),!(!a&&!b)}}};return"undefined"!=typeof exports&&exports(c),c}();